# =============================================================================
# Homelab Docker Compose Configuration
# =============================================================================
# All-in-one homelab setup with media server, home automation, cloud storage,
# file sync, monitoring, and VPN.
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. Run: docker compose up -d
#   3. Access services at http://homelab:<port>
# =============================================================================

services:
  # ===========================================================================
  # DATABASE (shared PostgreSQL)
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-homelab}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - TZ=${TZ}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-homelab}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # MEDIA SERVER
  # ===========================================================================
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/jellyfin:/config
      - /mnt/nas/media:/media:ro
    ports:
      - "8096:8096"
    # Hardware acceleration (Intel Quick Sync) - uncomment if needed
    # devices:
    #   - /dev/dri:/dev/dri

  # ===========================================================================
  # HOME AUTOMATION
  # ===========================================================================
  homeassistant:
    image: homeassistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    environment:
      - TZ=${TZ}
    volumes:
      - ./config/homeassistant:/config
    ports:
      - "8123:8123"
    # For USB devices (Zigbee/Z-Wave sticks), uncomment:
    # privileged: true
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0

  # ===========================================================================
  # TORRENTS
  # ===========================================================================
  transmission:
    image: lscr.io/linuxserver/transmission:latest
    container_name: transmission
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - USER=${TRANSMISSION_USER}
      - PASS=${TRANSMISSION_PASS}
    volumes:
      - ./config/transmission:/config
      - /mnt/nas/downloads:/downloads
      - /mnt/nas/downloads/watch:/watch
    ports:
      - "9091:9091"
      - "51413:51413"
      - "51413:51413/udp"

  # ===========================================================================
  # CLOUD STORAGE
  # ===========================================================================
  nextcloud:
    image: lscr.io/linuxserver/nextcloud:latest
    container_name: nextcloud
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/nextcloud:/config
      - /mnt/nas/nextcloud:/data
    ports:
      - "8080:443"
    depends_on:
      postgres:
        condition: service_healthy

  # ===========================================================================
  # FILE SYNC
  # ===========================================================================
  syncthing:
    image: syncthing/syncthing:latest
    container_name: syncthing
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/syncthing:/var/syncthing/config
      - /mnt/nas/syncthing:/var/syncthing/data
    ports:
      - "8384:8384"   # Web UI
      - "22000:22000/tcp"  # TCP file transfers
      - "22000:22000/udp"  # QUIC file transfers
      - "21027:21027/udp"  # Receive local discovery broadcasts

  # ===========================================================================
  # MONITORING
  # ===========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /:/host:ro,rslave
    ports:
      - "9100:9100"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASS}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

  # ===========================================================================
  # VPN
  # ===========================================================================
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - SERVERURL=${WG_SERVERURL}
      - SERVERPORT=${WG_SERVERPORT:-51820}
      - PEERS=${WG_PEERS}
      - PEERDNS=auto
      - INTERNAL_SUBNET=10.100.0.0
      - ALLOWEDIPS=0.0.0.0/0
    volumes:
      - ./config/wireguard:/config
      - /lib/modules:/lib/modules:ro
    ports:
      - "51820:51820/udp"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1

  # ===========================================================================
  # DYNAMIC DNS (Porkbun)
  # ===========================================================================
  porkbun-ddns:
    image: python:3.12-alpine
    container_name: porkbun-ddns
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "pip install --no-cache-dir requests &&
             python ddns.py"
    environment:
      - TZ=${TZ}
      - PORKBUN_API_KEY=${PORKBUN_API_KEY}
      - PORKBUN_SECRET_KEY=${PORKBUN_SECRET_KEY}
      - PORKBUN_DOMAIN=${PORKBUN_DOMAIN}
      - PORKBUN_SUBDOMAIN=${PORKBUN_SUBDOMAIN:-@}
      - DDNS_INTERVAL=${DDNS_INTERVAL:-300}
    volumes:
      - ./scripts/ddns.py:/app/ddns.py:ro

  # ===========================================================================
  # DASHBOARD
  # ===========================================================================
  dashboard:
    image: python:3.12-slim
    container_name: dashboard
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "pip install --no-cache-dir -r requirements.txt &&
             gunicorn --bind 0.0.0.0:80 --workers 2 --access-logfile - app:app"
    environment:
      - TZ=${TZ}
      - PROMETHEUS_URL=http://prometheus:9090
      - WG_SERVERURL=${WG_SERVERURL}
      - WG_SERVERPORT=${WG_SERVERPORT:-51820}
      - DASHBOARD_HOST=${DASHBOARD_HOST:-}
    volumes:
      - ./dashboard:/app:ro
    ports:
      - "80:80"
    depends_on:
      - prometheus

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
